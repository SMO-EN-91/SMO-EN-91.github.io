<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-16" />
<title>Carte Eligibilité Essonne Numérique</title>

<!-- ✅ Meta viewport optimisée pour Android et iOS -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<!-- ✅ Mode plein écran Android/iOS -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a3d62">
<meta name="background-color" content="#0a3d62">

<!-- Mapbox -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

<style>
  /* === Base === */
  html, body {
    margin: 0;
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
    height: 100dvh; /* meilleure gestion Android */
    overflow: hidden; /* évite les scrolls parasites */
    box-sizing: border-box;
  }

  @supports not (height: 100dvh) {
    html, body {
      height: 100vh;
    }
  }

  /* === Carte plein écran stable === */
  #map {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100dvh;
  }

  @supports not (height: 100dvh) {
    #map {
      height: 100vh;
    }
  }

  /* === Bloc sélection de fond de plan === */
  #style-select-container {
    position: fixed;
    top: env(safe-area-inset-top, 10px);
    left: env(safe-area-inset-left, 10px);
    z-index: 20;
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    padding: 4px 6px;
    height: 40px; /* même hauteur que la barre d’adresse */
    font-family: "Helvetica Neue", Arial, sans-serif;
    gap: 6px;
  }

  #style-select-container label {
    font-size: 14px;
    font-weight: 500;
    margin-right: 4px;
  }

  #style-select {
    height: 30px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 6px;
    outline: none;
  }

  /* === Légende === */
  .legend2 {
    background-color: #fff;
    border-radius: 6px;
    bottom: env(safe-area-inset-bottom, 20px);
    right: env(safe-area-inset-right, 10px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    padding: 8px;
    position: fixed;
    z-index: 10;
  }

  .legend2 h4 { margin: 0 0 10px; }
  .legend2 div span {
    border-radius: 50%;
    display: inline-block;
    height: 10px;
    margin-right: 5px;
    width: 10px;
  }

  /* === Harmonisation avec la barre Mapbox Geocoder === */
  .mapboxgl-ctrl-geocoder {
    min-width: 260px;
    height: 40px; /* même hauteur que le sélecteur */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 8px;
    overflow: hidden;
    font-size: 14px;
  }

  .mapboxgl-ctrl-geocoder--input {
    height: 38px !important;
    line-height: 38px !important;
    font-size: 14px;
  }

  .mapboxgl-ctrl-geocoder--icon {
    margin-top: 8px;
  }
</style>
</head>

<body>
<!-- Plugins Mapbox -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
<link
  rel="stylesheet"
  href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
  type="text/css"
/>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

<!-- ✅ Conteneur fixe pour le sélecteur -->
<div id="style-select-container">
  <label for="style-select">Choisir fond de plan : </label>
  <select id="style-select">
    <option value="mapbox://styles/ballereau/ck7bzhy7q00fq1irwkzovmv89">Plan standard</option>
    <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite + rues</option>
    <option value="mapbox://styles/mapbox/satellite-v9">Satellite uniquement</option>
  </select>
</div>

<!-- Carte Mapbox -->
<div id="map"></div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYmFsbGVyZWF1IiwiYSI6ImNrOGZ5Z3M2MzA0dHAzZXBrcDQwbzN5YzIifQ.UpKvOA9C3E4M9bOoG7r1yg';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/ballereau/ck7bzhy7q00fq1irwkzovmv89',
    center: [2.306518, 48.523618],
    zoom: 9.5
  });

  // === Sélecteur de fond de plan ===
  document.getElementById('style-select').addEventListener('change', function() {
    map.setStyle(this.value);
  });

  // === Barre de recherche d'adresse ===
  map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    countries: 'fr',
    mapboxgl: mapboxgl
  }));

  // === Couches personnalisées ===
  function addCustomSourcesAndLayers() {
    if (!map.getSource('prises-commercialisables')) {
      map.addSource('prises-commercialisables', {
        type: 'vector',
        url: 'mapbox://ballereau.3ro4yq88'
      });
    }
    if (!map.getLayer('prises-commercialisables')) {
      map.addLayer({
        id: 'prises-commercialisables',
        type: 'circle',
        source: 'prises-commercialisables',
        'source-layer': 'Prises_commercialisables-dcem7s',
        paint: {
          'circle-radius': 3,
          'circle-color': [
            'match',
            ['get', 'STATUT'],
            'ELIGIBLE', '#2ac537',
            'NON ELIGIBLE', '#F79C0B',
            '#ccc'
          ]
        }
      });
    }
    if (!map.getLayer('prises-arcep')) {
      map.addSource('prises-arcep', {
        type: 'vector',
        url: 'mapbox://ballereau.aap4yt84'
      });
      map.addLayer({
        id: 'prises-arcep',
        type: 'circle',
        source: 'prises-arcep',
        'source-layer': 'Prises_arcep-apqk9x',
        paint: {
          'circle-radius': 3,
          'circle-color': [
            'match',
            ['get', 'STATUT'],
            'ELIGIBLE', '#2ac537',
            'NON ELIGIBLE', '#F79C0B',
            '#ccc'
          ]
        }
      });
    }
  }

  map.on('styledata', addCustomSourcesAndLayers);
  map.on('load', addCustomSourcesAndLayers);
</script>

<!-- ✅ Légende fixe et stable -->
<div id="prises-commercialisables" class="legend2">
  Déploiement des bâtiments
  <div><span style="background-color: #2ac537"></span>éligible</div>
  <div><span style="background-color: #F79C0B"></span>non éligible</div>
  <small>Source: <a href="http://essonnenumerique.com/" target="_blank">Essonne Numérique</a></small>
</div>
</body>
</html>
