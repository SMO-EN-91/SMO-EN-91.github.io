<!DOCTYPE html>
<html>
<head>
<meta charset="utf-16" />
<title>Carte Eligibilité Essonne Numérique</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  .legend2 {
    background-color: #fff;
    border-radius: 3px;
    bottom: 30px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    padding: 5px;
    position: absolute;
    right: 10px;
    z-index: 10;
  }

  .legend2 div span {
    border-radius: 50%;
    display: inline-block;
    height: 10px;
    margin-right: 5px;
    width: 10px;
  }

  /* Conteneur Street View */
  #streetview-container {
    position: absolute;
    bottom: 10px;
    left: 10px;
    width: 400px;
    height: 300px;
    z-index: 30;
    display: none;
    border: 2px solid #aaa;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    background: white;
  }

  /* Bouton Street View global */
  #streetview-btn {
    position: absolute;
    top: 50px;
    right: 10px;
    z-index: 20;
    background: white;
    padding: 6px 10px;
    border-radius: 4px;
    border: 1px solid #999;
    cursor: pointer;
    font-family: sans-serif;
  }
  #streetview-btn:hover {
    background: #f0f0f0;
  }
</style>
</head>
<body>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
<link
  rel="stylesheet"
  href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
  type="text/css"
/>

<!-- Sélecteur de fond de plan -->
<div style="position: absolute; top: 10px; left: 10px; z-index: 20; background: white; padding: 5px; border-radius: 4px;">
  <label for="style-select">Choisir fond de plan : </label>
  <select id="style-select">
    <option value="mapbox://styles/ballereau/ck7bzhy7q00fq1irwkzovmv89">Plan standard</option>
    <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite + rues</option>
    <option value="mapbox://styles/mapbox/satellite-v9">Satellite uniquement</option>
  </select>
</div>

<!-- Bouton Street View intégré -->
<button id="streetview-btn">Street View intégré</button>

<!-- Fenêtre Street View -->
<div id="streetview-container"></div>

<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYmFsbGVyZWF1IiwiYSI6ImNrOGZ5Z3M2MzA0dHAzZXBrcDQwbzN5YzIifQ.UpKvOA9C3E4M9bOoG7r1yg';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/ballereau/ck7bzhy7q00fq1irwkzovmv89',
  center: [2.306518, 48.523618],
  zoom: 9.5
});

document.getElementById('style-select').addEventListener('change', function() {
  map.setStyle(this.value);
});

// Geocoder
map.addControl(new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  countries: 'fr',
  mapboxgl: mapboxgl
}));

// === FONCTION POUR CHARGER LES COUCHES ===
function addCustomSourcesAndLayers() {
  // === PRISES COMMERCIALISABLES ===
  if (!map.getSource('prises-commercialisables')) {
    map.addSource('prises-commercialisables', {
      type: 'vector',
      url: 'mapbox://ballereau.3ro4yq88'
    });
  }

  if (!map.getLayer('prises-commercialisables')) {
    map.addLayer({
      id: 'prises-commercialisables',
      type: 'circle',
      source: 'prises-commercialisables',
      'source-layer': 'Prises_commercialisables-dcem7s',
      paint: {
        'circle-radius': 3,
        'circle-color': [
          'match',
          ['get', 'STATUT'],
          'ELIGIBLE', '#2ac537',
          'NON ELIGIBLE', '#F79C0B',
          '#ccc'
        ]
      }
    });
  }

  if (!map.getLayer('prises-commercialisables-hitbox')) {
    map.addLayer({
      id: 'prises-commercialisables-hitbox',
      type: 'circle',
      source: 'prises-commercialisables',
      'source-layer': 'Prises_commercialisables-dcem7s',
      paint: {
        'circle-radius': [
          'interpolate', ['linear'], ['zoom'],
          8, 15,
          14, 10
        ],
        'circle-color': 'rgba(0,0,0,0)'
      }
    });
  }

  if (!map.getLayer('prises-commercialisables-highlight')) {
    map.addLayer({
      id: 'prises-commercialisables-highlight',
      type: 'circle',
      source: 'prises-commercialisables',
      'source-layer': 'Prises_commercialisables-dcem7s',
      paint: {
        'circle-radius': 10,
        'circle-color': '#00ffff',
        'circle-opacity': 0.4
      },
      filter: ['==', 'ad_batcode', '']
    });
  }

  // === PRISES ARCEP ===
  if (!map.getSource('prises-arcep')) {
    map.addSource('prises-arcep', {
      type: 'vector',
      url: 'mapbox://ballereau.aap4yt84'
    });
  }

  if (!map.getLayer('prises-arcep')) {
    map.addLayer({
      id: 'prises-arcep',
      type: 'circle',
      source: 'prises-arcep',
      'source-layer': 'Prises_arcep-apqk9x',
      paint: {
        'circle-radius': 3,
        'circle-color': [
          'match',
          ['get', 'STATUT'],
          'ELIGIBLE', '#2ac537',
          'NON ELIGIBLE', '#F79C0B',
          '#ccc'
        ]
      }
    });
  }

  if (!map.getLayer('prises-arcep-hitbox')) {
    map.addLayer({
      id: 'prises-arcep-hitbox',
      type: 'circle',
      source: 'prises-arcep',
      'source-layer': 'Prises_arcep-apqk9x',
      paint: {
        'circle-radius': [
          'interpolate', ['linear'], ['zoom'],
          8, 15,
          14, 10
        ],
        'circle-color': 'rgba(0,0,0,0)'
      }
    });
  }

  if (!map.getLayer('prises-arcep-highlight')) {
    map.addLayer({
      id: 'prises-arcep-highlight',
      type: 'circle',
      source: 'prises-arcep',
      'source-layer': 'Prises_arcep-apqk9x',
      paint: {
        'circle-radius': 10,
        'circle-color': '#00ffff',
        'circle-opacity': 0.4
      },
      filter: ['==', 'imb_id', '']
    });
  }
}

map.on('styledata', addCustomSourcesAndLayers);

map.on('load', function() {
  addCustomSourcesAndLayers();

  // === Popup prises-commercialisables ===
  map.on('click', 'prises-commercialisables-hitbox', function(e) {
    const feature = e.features[0];
    const coords = feature.geometry.coordinates;
    const lat = coords[1].toFixed(6);
    const lng = coords[0].toFixed(6);

    new mapboxgl.Popup({ offset: [0, -15] })
      .setLngLat(coords)
      .setHTML(`
        <p><strong>Informations sur le bâtiment :</strong></p>
        <p>${feature.properties.Voie}</p>
        <p>${feature.properties.Commune}</p>
        <p>Statut du bâtiment : ${feature.properties.EtatImmeuble}</p>
        <p>ad_batcode : ${feature.properties.ad_batcode}</p>
        <p>ad_hexaclé : ${feature.properties.ad_hexacle}</p>
        <p><a href="#" class="open-streetview" data-lat="${lat}" data-lng="${lng}">Ouvrir Street View ici</a></p>
      `)
      .addTo(map);
  });

  // === Popup prises-arcep ===
  map.on('click', 'prises-arcep', function(e) {
    const feature = e.features[0];
    const coords = feature.geometry.coordinates;
    const lat = coords[1].toFixed(6);
    const lng = coords[0].toFixed(6);

    new mapboxgl.Popup({ offset: [0, -15] })
      .setLngLat(coords)
      .setHTML(`
        <p><strong>Informations sur le bâtiment :</strong></p>
        <p>${feature.properties.Voie}</p>
        <p>${feature.properties.Commune}</p>
        <p>État : ${feature.properties.imb_etat}</p>
        <p><a href="#" class="open-streetview" data-lat="${lat}" data-lng="${lng}">Ouvrir Street View ici</a></p>
      `)
      .addTo(map);
  });
});

// === GESTION DE LA STREET VIEW ===
const streetViewContainer = document.getElementById('streetview-container');
const iframe = document.createElement('iframe');
iframe.style.width = '100%';
iframe.style.height = '100%';
iframe.style.border = '0';
streetViewContainer.appendChild(iframe);

// Fonction d'affichage
function openStreetViewAt(lat, lng) {
  const url = `https://www.google.com/maps/embed?pb=!4v0!6m8!1m3!1d0!2d${lng}!3d${lat}!3m2!1i1024!2i768!4f0!5f0.7820865974627469`;
  iframe.src = url;
  streetViewContainer.style.display = 'block';
}

function toggleStreetView() {
  const center = map.getCenter();
  openStreetViewAt(center.lat.toFixed(6), center.lng.toFixed(6));
  if (streetViewContainer.style.display === 'block') {
    streetViewContainer.style.display = 'none';
  } else {
    streetViewContainer.style.display = 'block';
  }
}

document.getElementById('streetview-btn').addEventListener('click', toggleStreetView);

// Clic sur lien dans popup
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('open-streetview')) {
    e.preventDefault();
    const lat = e.target.getAttribute('data-lat');
    const lng = e.target.getAttribute('data-lng');
    openStreetViewAt(lat, lng);
  }
});
</script>

<div id="prises-commercialisables" class="legend2">
  Déploiement des bâtiments
  <div><span style="background-color: #2ac537"></span>éligible</div>
  <div><span style="background-color: #F79C0B"></span>non éligible</div>
  <small>Source: <a href="http://essonnenumerique.com/" target="_blank">Essonne Numérique</a></small>
</div>
</body>
</html>
